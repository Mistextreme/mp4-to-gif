<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<title>MP4 → GIF Converter (Self-hosted WASM)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
/* Compact styles */
:root{--bg:#050509;--card:#0b0d19;--accent:#4e54c8;--accent2:#03dac5;--text:#f4f5ff}
body{margin:0;padding:18px;background:radial-gradient(circle at top,#151633 0,#050509 55%);color:var(--text);font-family:system-ui,Segoe UI,Arial}
.container{max-width:900px;margin:0 auto}
h1{text-align:center;margin:8px 0 18px}
.drop{border:2px dashed rgba(78,84,200,.35);padding:20px;border-radius:10px;text-align:center;background:linear-gradient(120deg,rgba(78,84,200,.02),transparent)}
.btn{background:linear-gradient(135deg,var(--accent),#6366f1);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
.list{margin-top:14px}
.item{background:var(--card);padding:8px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.results{margin-top:16px}
.result{background:var(--card);padding:8px;border-radius:8px;margin-bottom:8px}
.small{font-size:13px;color:#aab}
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:99}
.overlay.show{display:flex}
.box{background:#071024;padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,.04)}
</style>
</head>
<body>
<div class="container">
  <h1>MP4 → GIF Converter (Self‑hosted WASM)</h1>

  <div class="drop" id="drop" title="Clique ou arraste">
    <input id="fileInput" type="file" accept="video/mp4" multiple style="display:none">
    <div class="small">Toque para selecionar ou arraste ficheiros .mp4</div>
    <div style="margin-top:10px"><button class="btn" id="pick">Selecionar ficheiros</button></div>
  </div>

  <div class="list" id="list"><div class="small">Nenhum ficheiro</div></div>

  <div style="margin-top:10px">
    <button class="btn" id="convert" disabled>Converter para GIF</button>
  </div>

  <h2 style="margin-top:18px">Resultados</h2>
  <div id="results" class="results"></div>
  <div class="small" style="margin-top:8px">Esta versão usa arquivos locais: <code>ffmpeg-core.js</code> e <code>ffmpeg-core.wasm</code>. Para funcionar, carrega esses ficheiros no mesmo repositório (root).</div>
</div>

<div id="overlay" class="overlay"><div class="box" id="overlayBox">A carregar...</div></div>

<!-- Note: this HTML expects these files to be present at the repo root:
     - ffmpeg-core.js
     - ffmpeg-core.wasm
     (and optionally ffmpeg-core.worker.js)
     The provided GitHub Action will fetch them automatically on push.
-->
<script>
const pick = document.getElementById('pick');
const fileInput = document.getElementById('fileInput');
const drop = document.getElementById('drop');
const list = document.getElementById('list');
const convertBtn = document.getElementById('convert');
const results = document.getElementById('results');
const overlay = document.getElementById('overlay');
const overlayBox = document.getElementById('overlayBox');

let files = [];

pick.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', e=> handleFiles(e.target.files));

['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=> { e.preventDefault(); drop.style.opacity=0.9 }));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=> { e.preventDefault(); drop.style.opacity=1 }));
drop.addEventListener('drop', e=> { e.preventDefault(); if(e.dataTransfer?.files) handleFiles(e.dataTransfer.files) });

function handleFiles(fileList){
  for(const f of fileList){
    if(f.type !== 'video/mp4' && !f.name.toLowerCase().endsWith('.mp4')) continue;
    files.push(f);
  }
  renderList();
}

function renderList(){
  list.innerHTML = '';
  if(files.length===0){ list.innerHTML='<div class="small">Nenhum ficheiro</div>'; convertBtn.disabled=true; return; }
  files.forEach((f,i)=>{
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = '<div><strong>'+f.name+'</strong><div class="small">'+Math.round(f.size/1024/1024)+' MB</div></div>';
    const rem = document.createElement('button'); rem.textContent='Remover'; rem.className='btn';
    rem.style.background='#666'; rem.onclick=()=>{ files.splice(i,1); renderList(); };
    el.appendChild(rem);
    list.appendChild(el);
  });
  convertBtn.disabled = files.length===0;
}

function showOverlay(txt){ overlayBox.textContent=txt; overlay.classList.add('show'); }
function hideOverlay(){ overlay.classList.remove('show'); }

async function ensureFFmpeg(){
  if(window._FFMPEG_LOADED) return window._FFMPEG;
  if(!window.FFmpeg || !FFmpeg.createFFmpeg) throw new Error('FFmpeg UMD não encontrado. Certifica-te que ffmpeg-core.js está presente e que incluíste a UMD ffmpeg script se necessário.');
  const ffmpeg = FFmpeg.createFFmpeg({ corePath: './ffmpeg-core.js', log:false });
  showOverlay('A carregar motor FFmpeg (local)...');
  await ffmpeg.load();
  window._FFMPEG_LOADED = true;
  window._FFMPEG = ffmpeg;
  hideOverlay();
  return ffmpeg;
}

convertBtn.addEventListener('click', async ()=>{
  try{
    const ffmpeg = await ensureFFmpeg();
    showOverlay('A converter...');
    results.innerHTML = '';
    for(let i=0;i<files.length;i++){
      const f = files[i];
      overlayBox.textContent = `A converter ${i+1}/${files.length} — ${f.name}`;
      const input = 'input'+i+'.mp4';
      const output = 'out'+i+'.gif';
      const fetchFile = FFmpeg.fetchFile || (async (file)=> new Uint8Array(await file.arrayBuffer()));
      ffmpeg.FS('writeFile', input, await fetchFile(f));
      await ffmpeg.run('-i', input, '-vf', 'fps=12,scale=360:-1:flags=lanczos', '-t', '20', '-y', output);
      const data = ffmpeg.FS('readFile', output);
      const blob = new Blob([data.buffer], { type:'image/gif' });
      const url = URL.createObjectURL(blob);
      const card = document.createElement('div'); card.className='result';
      card.innerHTML = '<div><strong>'+(f.name.replace(/\.mp4$/i,'')) + '.gif</strong></div><div style="margin-top:6px"><img src="'+url+'" style="max-width:100%;border-radius:8px"></div><div style="margin-top:6px"><a href="'+url+'" download="'+(f.name.replace(/\.mp4$/i,'')+'.gif')+'" class="btn">Baixar GIF</a></div>';
      results.appendChild(card);
      try{ ffmpeg.FS('unlink', input); ffmpeg.FS('unlink', output); }catch(e){}
    }
    hideOverlay();
  }catch(err){
    hideOverlay();
    alert('Erro: '+ (err && err.message ? err.message : err));
    console.error(err);
  }
});

// initial hint: check ffmpeg-core.js presence
fetch('./ffmpeg-core.js', {method:'HEAD'}).then(r=>{ if(!r.ok) console.warn('ffmpeg-core.js não disponível no root — usa o workflow para obter os ficheiros automaticamente.'); }).catch(()=>{ console.warn('ffmpeg-core.js HEAD failed'); });

</script>
</body>
</html>
