<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quantum Matrix — MP4 → GIF</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* ------------------------------
   Quantum Matrix — Visual Theme
   ------------------------------ */
:root{
  --bg:#020204;
  --panel:rgba(255,255,255,0.03);
  --accent:#00ff9c;
  --accent2:#45b8ff;
  --danger:#ff4d6d;
  --muted:rgba(255,255,255,0.55);
  --glass: rgba(255,255,255,0.02);
  --radius:12px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:
  radial-gradient(800px 400px at 10% 10%, rgba(69,184,255,0.03), transparent 10%),
  linear-gradient(180deg,var(--bg), #040414 60%);
  color:#cfefff;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  overflow-y:auto;
}

/* Canvas matrix */
#matrixCanvas{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:0.8;mix-blend-mode:screen}

/* layout */
.wrapper{position:relative;z-index:1;max-width:1100px;margin:28px auto;padding:20px}
.header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
.brand{
  display:flex;align-items:center;gap:12px;background:linear-gradient(90deg, rgba(0,0,0,0.35), rgba(255,255,255,0.01));
  padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,0.02);
  box-shadow:0 8px 30px rgba(2,6,23,0.6);
}
.logo{width:64px;height:64px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent2),var(--accent));color:#001218;font-weight:900;font-family:var(--mono);font-size:22px}
.title h1{margin:0;font-size:20px}
.title p{margin:0;color:var(--muted);font-size:12px}

/* main grid */
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}

/* panel */
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);box-shadow:0 12px 40px rgba(2,6,23,0.6);position:relative;overflow:hidden}
.panel .title{font-weight:700;margin-bottom:8px}

/* drop area */
.drop{
  border-radius:10px;padding:20px;border:1px dashed rgba(69,184,255,0.08);min-height:160px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;
  transition: transform .18s ease, box-shadow .18s ease;
}
.drop.drag{transform:translateY(-6px);box-shadow:0 26px 60px rgba(0,0,0,0.6);border-color:rgba(0,255,156,0.2)}
.drop .big{font-size:15px;font-weight:800;color: #e0fff7}
.drop .small{font-size:12px;color:var(--muted)}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#012; padding:9px 14px;border-radius:10px;border:none;font-weight:800;cursor:pointer;box-shadow:0 10px 30px rgba(69,184,255,0.06)}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);font-weight:700}
.btn.warn{background:linear-gradient(90deg,#ff9579,#ff5a8a);color:white}

/* file list */
.file-list{margin-top:12px;display:flex;flex-direction:column;gap:10px;max-height:320px;overflow:auto;padding-right:6px}
.file-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
.file-thumb{width:96px;height:60px;border-radius:8px;background:linear-gradient(90deg,#001022, rgba(3,12,30,0.5));display:flex;align-items:center;justify-content:center;font-family:var(--mono);color:var(--muted);font-size:12px}
.file-meta{flex:1;min-width:0}
.file-name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.file-info{color:var(--muted);font-size:12px;display:flex;gap:8px;align-items:center}
.file-actions{display:flex;gap:8px}

/* right panel controls */
.controls{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.preset{display:flex;gap:8px;align-items:center}
.select{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:#cfefff}

/* progress */
.progressWrap{margin-top:8px}
.progress{height:12px;border-radius:999px;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));overflow:hidden;border:1px solid rgba(255,255,255,0.02)}
.progress .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .18s linear;box-shadow:0 8px 30px rgba(69,184,255,0.08) inset}

/* terminal log */
.terminal{font-family:var(--mono);font-size:12px;color:#cfefff;background:linear-gradient(180deg, rgba(0,0,0,0.5), rgba(0,0,0,0.25));padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);min-height:90px;max-height:260px;overflow:auto}

/* results */
.resultsGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:10px}
.resultCard{padding:8px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px;align-items:center}
.resultCard img{width:100%;border-radius:6px;object-fit:cover}

/* glitch header effect */
.glitch {
  position:relative; display:inline-block; color: #bff; font-weight:900; font-family:var(--mono);
}
.glitch::before, .glitch::after { content: attr(data-text); position:absolute; left:0; top:0; width:100%; overflow:hidden; }
.glitch::before{left:2px;text-shadow:-2px 0 var(--accent2);clip-path:polygon(0 0,100% 0,100% 45%,0 45%);opacity:0.9}
.glitch::after{left:-2px;text-shadow:-2px 0 var(--accent);clip-path:polygon(0 55%,100% 55%,100% 100%,0 100%);opacity:0.9;}

/* footer */
.footer{margin:30px auto 80px;color:var(--muted);text-align:center;font-size:13px}

/* responsive */
@media (max-width:980px){ .grid{grid-template-columns:1fr} .logo{width:52px;height:52px} .header{flex-direction:column;align-items:flex-start} }
</style>
</head>
<body>

<canvas id="matrixCanvas"></canvas>

<div class="wrapper" role="main" aria-label="Quantum Matrix MP4 to GIF">
  <div class="header" role="banner">
    <div class="brand" aria-hidden="true">
      <div class="logo">QM</div>
      <div class="title">
        <h1><span class="glitch" data-text="Quantum Matrix">Quantum Matrix</span> — MP4 → GIF</h1>
        <p>Converte localmente no browser. Privacidade, performance e efeito visual.</p>
      </div>
    </div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button id="resetBtn" class="btn ghost" title="Resetar"><i class="fa-solid fa-rotate"></i>&nbsp;Reset</button>
      <button id="helpBtn" class="btn" title="Ajuda rápida"><i class="fa-regular fa-circle-question"></i>&nbsp;Ajuda</button>
    </div>
  </div>

  <div class="grid">

    <!-- LEFT -->
    <div class="panel" aria-labelledby="upload">
      <div id="drop" class="drop" role="region" aria-label="Drop zone">
        <div class="big"><i class="fa-solid fa-cloud-arrow-up" style="margin-right:8px"></i> Arraste, solte ou toque</div>
        <div class="small">Apenas ficheiros <strong>.mp4</strong>. Múltiplos permitidos. Processamento local (FFmpeg no teu domínio).</div>
        <input id="fileInput" type="file" accept="video/mp4" multiple style="display:none">
        <div style="margin-top:10px"><button id="chooseBtn" class="btn">Selecionar ficheiros</button></div>
      </div>

      <div class="file-list" id="fileList" aria-live="polite"></div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <div class="preset">
          <label style="color:var(--muted);font-size:13px;margin-right:8px">Preset</label>
          <select id="preset" class="select" aria-label="Preset">
            <option value="fast">Rápido — 8fps · 360px</option>
            <option value="balanced" selected>Equilíbrio — 12fps · 480px</option>
            <option value="quality">Qualidade — 18fps · 720px</option>
          </select>
        </div>

        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="convertBtn" class="btn" disabled><i class="fa-solid fa-magic"></i>&nbsp;Converter</button>
          <button id="downloadZipBtn" class="btn ghost" disabled><i class="fa-solid fa-file-zipper"></i>&nbsp;ZIP</button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel" aria-labelledby="controls">
      <div class="controls">
        <div>
          <div style="font-weight:800">Estado</div>
          <div style="color:var(--muted);font-size:13px">Progresso do motor e conversão</div>
        </div>
        <div id="status" style="font-weight:700;color:var(--accent)">Aguardando</div>
      </div>

      <div class="progressWrap">
        <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>
      </div>

      <div style="margin-top:12px" class="terminal" id="terminal">Console vazio. Inicie conversão para ver o log.</div>

      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Resultados (<span id="count">0</span>)</div>
        <div style="color:var(--muted);font-size:13px">Baixe ou visualize</div>
      </div>

      <div class="resultsGrid" id="results"></div>
    </div>

  </div>

  <div class="footer">Quantum Matrix — Privacidade & Performance. Mantém no root: <code>ffmpeg.min.js</code>, <code>ffmpeg-core.js</code>, <code>ffmpeg-core.wasm</code>.</div>
</div>

<!-- overlay -->
<div id="overlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,0.6)">
  <div style="background:#07101a;padding:16px;border-radius:10px;color:#dff;font-family:var(--mono)"><span id="overlayText">A carregar...</span></div>
</div>

<!-- local FFmpeg UMD (required to be in repo root) -->
<script src="./ffmpeg.min.js"></script>
<!-- JSZip (for ZIP downloads). If blocked by DNS, ZIP fails but individual downloads still work -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
/* Quantum Matrix — JS
   - Matrix canvas background
   - Drag & drop + select
   - Preview
   - FFmpeg local usage (ffmpeg-core.js)
   - Convert MP4 -> GIF with presets
   - Log & progress
   - Download individual & ZIP
*/

(() => {
  /* ---------- Matrix Background ---------- */
  const canvas = document.getElementById('matrixCanvas');
  const ctx = canvas.getContext('2d');
  let cols, rows, fontSize = 14, drops;

  function resizeCanvas(){
    canvas.width = innerWidth;
    canvas.height = innerHeight;
    cols = Math.floor(canvas.width / fontSize);
    rows = Math.floor(canvas.height / fontSize);
    drops = new Array(cols).fill(0).map(() => Math.floor(Math.random() * rows));
  }
  function matrixLoop(){
    ctx.fillStyle = 'rgba(0,0,0,0.12)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.font = fontSize + 'px monospace';
    for(let i=0;i<cols;i++){
      const text = String.fromCharCode(0x30A0 + Math.random() * 96); // katakana-like
      ctx.fillStyle = i % 2 ? 'rgba(69,184,255,0.65)' : 'rgba(0,255,156,0.65)';
      ctx.fillText(text, i*fontSize, drops[i]*fontSize);
      if(drops[i]*fontSize > canvas.height || Math.random() > 0.975) drops[i] = 0;
      drops[i]++;
    }
    requestAnimationFrame(matrixLoop);
  }
  window.addEventListener('resize', () => { resizeCanvas(); });
  resizeCanvas();
  matrixLoop();

  /* ---------- Elements ---------- */
  const fileInput = document.getElementById('fileInput');
  const chooseBtn = document.getElementById('chooseBtn');
  const drop = document.getElementById('drop');
  const fileList = document.getElementById('fileList');
  const presetSel = document.getElementById('preset');
  const convertBtn = document.getElementById('convertBtn');
  const downloadZipBtn = document.getElementById('downloadZipBtn');
  const bar = document.getElementById('bar');
  const status = document.getElementById('status');
  const terminal = document.getElementById('terminal');
  const results = document.getElementById('results');
  const countEl = document.getElementById('count');
  const overlay = document.getElementById('overlay');
  const overlayText = document.getElementById('overlayText');
  const resetBtn = document.getElementById('resetBtn');
  const helpBtn = document.getElementById('helpBtn');

  /* ---------- State ---------- */
  const state = {
    files: [], // {id,file,name,size,url}
    gifs: [],  // {name,blob,url,size}
    ffmpeg: null,
    loaded: false,
    converting: false
  };

  const PRESETS = {
    fast: { fps: 8, width: 360, duration: 20 },
    balanced: { fps: 12, width: 480, duration: 20 },
    quality: { fps: 18, width: 720, duration: 30 }
  };

  // helpers
  const uid = (n=6) => Math.random().toString(36).slice(2,2+n);
  const fmt = (b) => { if(!b && b !== 0) return '-'; const s=['B','KB','MB','GB']; if(b===0) return '0 B'; const i=Math.floor(Math.log(b)/Math.log(1024)); return (b/Math.pow(1024,i)).toFixed(i===0?0:1)+' '+s[i]; };
  const log = (t) => { const d=document.createElement('div'); d.textContent = `[${new Date().toLocaleTimeString()}] ${t}`; terminal.appendChild(d); terminal.scrollTop = terminal.scrollHeight; };
  const showOverlay = (t) => { overlayText.textContent = t; overlay.style.display='flex'; };
  const hideOverlay = () => { overlay.style.display='none'; };

  /* ---------- File handling ---------- */
  chooseBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => handleFiles(e.target.files));

  ['dragenter','dragover'].forEach(evt => drop.addEventListener(evt, (e) => { e.preventDefault(); drop.classList.add('drag'); }));
  ['dragleave','drop'].forEach(evt => drop.addEventListener(evt, (e) => { e.preventDefault(); drop.classList.remove('drag'); }));
  drop.addEventListener('drop', (e) => { e.preventDefault(); if(e.dataTransfer?.files) handleFiles(e.dataTransfer.files); });

  function handleFiles(list){
    const arr = Array.from(list || []);
    let added = 0;
    for(const f of arr){
      if(!f.type.includes('video') && !f.name.toLowerCase().endsWith('.mp4')) continue;
      const id = uid(8);
      const url = URL.createObjectURL(f);
      state.files.push({ id, file: f, name: f.name, size: f.size, url });
      added++;
    }
    if(added) log(`Adicionados ${added} ficheiro(s).`);
    renderFileList();
  }

  function renderFileList(){
    fileList.innerHTML = '';
    if(!state.files.length){
      fileList.innerHTML = `<div style="color:var(--muted)">Nenhum ficheiro seleccionado.</div>`; convertBtn.disabled = true; return;
    }
    state.files.forEach((f, idx) => {
      const el = document.createElement('div'); el.className='file-item';
      const thumb = document.createElement('div'); thumb.className='file-thumb'; thumb.textContent='MP4';
      const meta = document.createElement('div'); meta.className='file-meta';
      const name = document.createElement('div'); name.className='file-name'; name.textContent = f.name;
      const info = document.createElement('div'); info.className='file-info'; info.innerHTML = `<span>${fmt(f.size)}</span><span>• MP4</span><span style="color:var(--muted);font-family:var(--mono);font-size:11px">${f.id}</span>`;
      meta.appendChild(name); meta.appendChild(info);
      const actions = document.createElement('div'); actions.className='file-actions';
      const preview = document.createElement('button'); preview.className='btn ghost'; preview.innerHTML='<i class="fa-regular fa-circle-play"></i>'; preview.title='Preview';
      preview.addEventListener('click', () => openPreview(f));
      const remove = document.createElement('button'); remove.className='btn ghost'; remove.innerHTML='<i class="fa-solid fa-trash"></i>'; remove.title='Remover';
      remove.addEventListener('click', () => { URL.revokeObjectURL(f.url); state.files.splice(idx,1); renderFileList(); });
      actions.appendChild(preview); actions.appendChild(remove);
      el.appendChild(thumb); el.appendChild(meta); el.appendChild(actions);
      fileList.appendChild(el);
    });
    convertBtn.disabled = state.files.length === 0;
  }

  // preview overlay
  let previewOverlay = null;
  function openPreview(entry){
    if(previewOverlay) closePreview();
    const overlayBox = document.createElement('div'); overlayBox.style.position='fixed'; overlayBox.style.inset='0'; overlayBox.style.background='rgba(1,3,6,0.9)'; overlayBox.style.display='flex'; overlayBox.style.alignItems='center'; overlayBox.style.justifyContent='center'; overlayBox.style.zIndex=9999;
    const card = document.createElement('div'); card.style.width='min(92vw,720px)'; card.style.borderRadius='10px'; card.style.overflow='hidden'; card.style.background='#000';
    const header = document.createElement('div'); header.style.padding='8px'; header.style.background='linear-gradient(90deg,#00121b,#081020)'; header.style.display='flex'; header.style.justifyContent='space-between';
    const title = document.createElement('div'); title.style.color='#dff'; title.textContent = entry.name;
    const closeBtn = document.createElement('button'); closeBtn.className='btn ghost'; closeBtn.innerHTML='<i class="fa-solid fa-xmark"></i>'; closeBtn.onclick = closePreview;
    header.appendChild(title); header.appendChild(closeBtn);
    const body = document.createElement('div'); body.style.padding='8px';
    const video = document.createElement('video'); video.src = entry.url; video.controls = true; video.style.width='100%'; video.autoplay=true;
    body.appendChild(video);
    card.appendChild(header); card.appendChild(body);
    overlayBox.appendChild(card);
    document.body.appendChild(overlayBox);
    previewOverlay = overlayBox;
    overlayBox.addEventListener('click', (e) => { if(e.target === overlayBox) closePreview(); });
  }
  function closePreview(){ if(previewOverlay){ previewOverlay.remove(); previewOverlay = null; } }

  /* ---------- FFmpeg integration ---------- */
  async function ensureFFmpeg(){
    if(state.loaded && state.ffmpeg) return state.ffmpeg;
    if(!window.FFmpeg || !FFmpeg.createFFmpeg) throw new Error('FFmpeg UMD não encontrado. Verifica ffmpeg.min.js no root.');
    const ffmpeg = FFmpeg.createFFmpeg({ corePath: './ffmpeg-core.js', log: true });
    showOverlay('A carregar motor FFmpeg (local) — pode demorar alguns segundos...');
    log('[FFmpeg] Inicializando...');
    ffmpeg.setProgress(({ ratio }) => {
      const p = Math.round(ratio * 100);
      bar.style.width = p + '%';
      status.textContent = `Carregando recursos — ${p}%`;
    });
    await ffmpeg.load();
    state.ffmpeg = ffmpeg;
    state.loaded = true;
    hideOverlay();
    log('[FFmpeg] Motor carregado.');
    return ffmpeg;
  }

  // convert button
  convertBtn.addEventListener('click', async () => {
    if(!state.files.length || state.converting) return;
    const preset = PRESETS[presetSel.value || presetSel.selectedOptions[0].value || 'balanced'] || PRESETS.balanced;
    try{
      await ensureFFmpeg();
    } catch(err){
      alert('Erro ao carregar FFmpeg: ' + (err.message || err));
      console.error(err);
      return;
    }

    state.converting = true;
    convertBtn.disabled = true;
    downloadZipBtn.disabled = true;
    results.innerHTML = '';
    terminal.innerHTML = '';
    log(`Iniciando conversão de ${state.files.length} ficheiro(s). Preset: ${presetSel.value || 'balanced'}`);

    // attach logger
    state.ffmpeg.setLogger(({ type, message }) => {
      if(message && message.trim()) log('[ffmpeg] ' + message);
    });

    const ffFetch = FFmpeg.fetchFile || (async (f) => new Uint8Array(await f.arrayBuffer()));
    let total = state.files.length;
    let done = 0;

    for(let i=0;i<state.files.length;i++){
      const entry = state.files[i];
      status.textContent = `Convertendo ${i+1}/${total}`;
      bar.style.width = `${Math.round((i/total)*100)}%`;
      const inName = `input_${uid(6)}.mp4`;
      const outName = `output_${uid(6)}.gif`;
      log(`Escrevendo: ${inName}`);
      try{
        const data = await ffFetch(entry.file);
        state.ffmpeg.FS('writeFile', inName, data);
        // show run progress via progress handler
        state.ffmpeg.setProgress(({ ratio }) => {
          const localPerc = Math.round(ratio * 100);
          bar.style.width = `${Math.round(((i + localPerc/100)/total)*100)}%`;
        });

        const vf = `fps=${preset.fps},scale=${preset.width}:-1:flags=lanczos`;
        const args = ['-i', inName, '-vf', vf, '-t', String(preset.duration), '-y', outName];
        log(`[ffmpeg] run ${args.join(' ')}`);
        await state.ffmpeg.run(...args);
        const outData = state.ffmpeg.FS('readFile', outName);
        // cleanup
        try{ state.ffmpeg.FS('unlink', inName); }catch(e){}
        try{ state.ffmpeg.FS('unlink', outName); }catch(e){}
        const blob = new Blob([outData.buffer], { type:'image/gif' });
        const url = URL.createObjectURL(blob);
        const name = entry.name.replace(/\.[^/.]+$/, '') + '.gif';
        state.gifs.push({ name, blob, url, size: blob.size });
        renderResults();
        done++;
        bar.style.width = `${Math.round((done/total)*100)}%`;
        status.textContent = `Concluído ${done}/${total}`;
        log(`Gerado: ${name} (${fmt(blob.size)})`);
      }catch(err){
        log('Erro na conversão: ' + (err.message || err));
        console.error(err);
      }
    }

    state.converting = false;
    convertBtn.disabled = false;
    downloadZipBtn.disabled = state.gifs.length === 0;
    status.textContent = 'Concluído';
    log('Todas conversões terminadas.');
  });

  /* ---------- Render results ---------- */
  function renderResults(){
    results.innerHTML = '';
    if(!state.gifs.length){
      results.innerHTML = `<div style="color:var(--muted)">Sem GIFs.</div>`;
      countEl.textContent = '0';
      return;
    }
    countEl.textContent = String(state.gifs.length);
    state.gifs.forEach((g, idx) => {
      const card = document.createElement('div'); card.className='resultCard';
      const img = document.createElement('img'); img.src = g.url; img.alt = g.name;
      const title = document.createElement('div'); title.style.fontWeight='800'; title.textContent = g.name;
      const info = document.createElement('div'); info.style.fontSize='12px'; info.style.color='var(--muted)'; info.textContent = fmt(g.size);
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.width='100%';
      const dl = document.createElement('a'); dl.className='btn'; dl.textContent='Baixar'; dl.href = g.url; dl.download = g.name; dl.style.flex='1';
      const open = document.createElement('a'); open.className='btn ghost'; open.textContent='Abrir'; open.href = g.url; open.target='_blank'; open.style.flex='1';
      actions.appendChild(dl); actions.appendChild(open);
      card.appendChild(img); card.appendChild(title); card.appendChild(info); card.appendChild(actions);
      results.appendChild(card);
    });
  }

  /* ---------- ZIP download ---------- */
  downloadZipBtn.addEventListener('click', async () => {
    if(!state.gifs.length) return;
    if(typeof JSZip === 'undefined'){
      alert('JSZip não disponível. Faça download individualmente.');
      return;
    }
    showOverlay('A criar ZIP...');
    const zip = new JSZip();
    const folder = zip.folder('gifs') || zip;
    state.gifs.forEach(g => folder.file(g.name, g.blob));
    const content = await zip.generateAsync({ type:'blob' }, (meta) => {
      bar.style.width = `${Math.round(meta.percent)}%`;
    });
    hideOverlay();
    const u = URL.createObjectURL(content);
    const a = document.createElement('a'); a.href = u; a.download = 'gifs-quantum.zip'; a.click();
    setTimeout(()=>URL.revokeObjectURL(u), 2000);
  });

  /* ---------- UI helpers ---------- */
  resetBtn.addEventListener('click', () => {
    if(!confirm('Resetar a aplicação (limpar ficheiros e resultados)?')) return;
    state.files.forEach(f => URL.revokeObjectURL(f.url));
    state.gifs.forEach(g => URL.revokeObjectURL(g.url));
    state.files = []; state.gifs = [];
    renderFileList(); renderResults();
    terminal.innerHTML = 'Console vazio. Inicie conversão para ver o log.';
    bar.style.width = '0%';
    status.textContent = 'Aguardando';
  });
  helpBtn.addEventListener('click', () => {
    alert('Quantum Matrix — Guia rápido:\\n1) Adicione MP4s (arraste/tóque)\\n2) Escolha um preset\\n3) Converter (tudo no seu browser)\\n4) Baixe os GIFs ou ZIP.\\n\\nNota: Os arquivos ffmpeg devem estar no root (ffmpeg.min.js, ffmpeg-core.js, ffmpeg-core.wasm).');
  });

  // initial check for ffmpeg-core.js
  (async () => {
    try{
      const r = await fetch('./ffmpeg-core.js', { method:'HEAD' });
      if(!r.ok) log('Aviso: ffmpeg-core.js não encontrado no root. Use o workflow para obter os ficheiros.');
      else log('ffmpeg-core.js disponível (local).');
    }catch(e){
      log('Aviso: falha ao verificar ffmpeg-core.js (fetch HEAD).');
    }
  })();

  // expose for debug
  window.QuantumMatrix = { state };

})();
</script>
</body>
</html>